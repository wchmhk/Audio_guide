<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è³å“¡ä¸­æ§å°</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 30px; background-color: #f0f8ff; }
        button { padding: 15px; font-size: 18px; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px; width: 90%; max-width: 350px; display: block; margin-left: auto; margin-right: auto; }

        /* æŒ‰éˆ•é¡è‰²å®šç¾© */
        #startBtn { background-color: #2ed573; } /* ç¶ è‰²ï¼šé–‹å§‹ */
        #pauseBtn { background-color: #ffa502; display: none; } /* æ©˜è‰²ï¼šæš«åœ */
        #resumeBtn { background-color: #1e90ff; display: none; } /* è—è‰²ï¼šæ¢å¾© */
        #endBtn { background-color: #ff4757; display: none; } /* ç´…è‰²ï¼šçµæŸ */

        #status { margin-top: 20px; font-size: 20px; color: #333; font-weight: bold; }
        .control-panel { border: 1px solid #ccc; padding: 20px; border-radius: 10px; background: white; max-width: 400px; margin: 0 auto; }
    </style>
</head>
<body>

    <h1>ğŸ™ï¸ å°è³å“¡ä¸­æ§å°</h1>

    <div class="control-panel">
        <div id="status">ç‹€æ…‹ï¼šæº–å‚™å°±ç·’ (é›¢ç·š)</div>
        <hr>
        <!-- æŒ‰éˆ•ç¾¤çµ„ -->
        <button id="startBtn">ğŸ”´ é–‹å§‹å°è¦½ (ä¸Šç·š)</button>
        <button id="pauseBtn">ï¸ğŸ”‡ æš«åœéº¥å…‹é¢¨ (å–æ°´æ¨¡å¼)</button>
        <button id="resumeBtn">ğŸ¤ æ¢å¾©èªªè©±</button>
        <button id="endBtn">â¹ï¸ çµæŸå°è¦½ (å…¨å“¡æ–·ç·š)</button>
    </div>

    <!-- å¼•å…¥ SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase è¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyDMSZ5dOERrdwDhCcYozn_XbE-7T3Om3ss",
          authDomain: "audio-guide-signal.firebaseapp.com",
          databaseURL: "https://audio-guide-signal-default-rtdb.firebaseio.com",
          projectId: "audio-guide-signal",
          storageBucket: "audio-guide-signal.firebasestorage.app",
          messagingSenderId: "173221122075",
          appId: "1:173221122075:web:a8214abe2d2239a20028be",
          measurementId: "G-NJ8SX0K49Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Agora è¨­å®š
        const APP_ID = "c553229d8402445a9a5262d2d573161d";
        const CHANNEL_NAME = "museum_tour_01";

        const tourStatusRef = ref(db, 'tours/' + CHANNEL_NAME + '/isActive');
        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        let localAudioTrack;

        // UI å…ƒç´ 
        const startBtn = document.getElementById("startBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const resumeBtn = document.getElementById("resumeBtn");
        const endBtn = document.getElementById("endBtn");
        const statusText = document.getElementById("status");

        // --- 1. æŒ‰ä¸‹ã€é–‹å§‹å°è¦½ã€‘ ---
        startBtn.addEventListener("click", async () => {
            try {
                // Agora é€£ç·š
                await client.setClientRole("host");
                await client.join(APP_ID, CHANNEL_NAME, null, null);
                localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                await client.publish([localAudioTrack]);

                // Firebase é–‹ç‡ˆ
                set(tourStatusRef, true);
                onDisconnect(tourStatusRef).set(false);

                // æ›´æ–° UI
                statusText.innerText = "ç‹€æ…‹ï¼šğŸŸ¢ å»£æ’­ä¸­ (Live)";
                startBtn.style.display = "none";
                pauseBtn.style.display = "block";
                endBtn.style.display = "block";

            } catch (error) {
                console.error(error);
                alert("å•Ÿå‹•å¤±æ•—");
            }
        });

        // --- 2. æŒ‰ä¸‹ã€æš«åœéº¥å…‹é¢¨ã€‘(ä¸æ‰£åœ˜å“¡ï¼ŒåªéœéŸ³) ---
        pauseBtn.addEventListener("click", async () => {
            if (localAudioTrack) {
                // é—œéµæŒ‡ä»¤ï¼šsetEnabled(false) ä»£è¡¨éœéŸ³ï¼Œä½†é€£ç·šé‚„åœ¨
                await localAudioTrack.setEnabled(false);

                statusText.innerText = "ç‹€æ…‹ï¼šğŸ¤ å·²æš«åœ (éœéŸ³ä¸­)";
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "block";
            }
        });

        // --- 3. æŒ‰ä¸‹ã€æ¢å¾©èªªè©±ã€‘ ---
        resumeBtn.addEventListener("click", async () => {
            if (localAudioTrack) {
                // é—œéµæŒ‡ä»¤ï¼šsetEnabled(true) ä»£è¡¨æ¢å¾©è²éŸ³
                await localAudioTrack.setEnabled(true);

                statusText.innerText = "ç‹€æ…‹ï¼šğŸŸ¢ å»£æ’­ä¸­ (Live)";
                resumeBtn.style.display = "none";
                pauseBtn.style.display = "block";
            }
        });

        // --- 4. æŒ‰ä¸‹ã€çµæŸå°è¦½ã€‘(å…¨å“¡æ–·ç·š) ---
        endBtn.addEventListener("click", async () => {
            try {
                // Firebase é—œç‡ˆ (é€™æœƒè§¸ç™¼åœ˜å“¡ç«¯è‡ªå‹•æ–·ç·š)
                set(tourStatusRef, false);

                // åœæ­¢ Agora
                if (localAudioTrack) {
                    localAudioTrack.stop();
                    localAudioTrack.close();
                }
                await client.leave();

                // é‚„åŸ UI
                statusText.innerText = "ç‹€æ…‹ï¼šâ¹ï¸ å·²çµæŸå°è¦½";
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
                endBtn.style.display = "none";
                startBtn.style.display = "block";

            } catch (error) {
                console.error(error);
            }
        });
    </script>
</body>
</html>
