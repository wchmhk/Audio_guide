<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜å“¡æ”¶è½ä»‹é¢</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 30px; background-color: #fff9ed; }
        button { padding: 15px; font-size: 18px; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px; width: 90%; max-width: 350px; }

        #joinBtn { background-color: #bdc3c7; cursor: not-allowed; }
        #joinBtn.active { background-color: #1e90ff; cursor: pointer; }

        #leaveBtn { background-color: #ff6348; display: none; }
        #status { margin-top: 20px; font-size: 18px; color: #333; font-weight: bold; }
        .info-box { border: 1px solid #ddd; padding: 20px; border-radius: 10px; background: white; margin-top: 20px;}
    </style>
</head>
<body>

    <h1>ğŸ§ å°è³è€³æ©Ÿæ¥æ”¶ç«¯</h1>

    <div class="info-box">
        <div id="status">ç‹€æ…‹ï¼šé€£ç·šè‡³è¨Šè™Ÿå¡”ä¸­...</div>
        <hr>
        <button id="joinBtn" disabled>â³ ç­‰å¾…å°è³å“¡é–‹æ©Ÿ...</button>
        <button id="leaveBtn">â¹ï¸ é€€å‡ºå°è¦½</button>
    </div>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase è¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyDMSZ5dOERrdwDhCcYozn_XbE-7T3Om3ss",
          authDomain: "audio-guide-signal.firebaseapp.com",
          databaseURL: "https://audio-guide-signal-default-rtdb.firebaseio.com",
          projectId: "audio-guide-signal",
          storageBucket: "audio-guide-signal.firebasestorage.app",
          messagingSenderId: "173221122075",
          appId: "1:173221122075:web:a8214abe2d2239a20028be",
          measurementId: "G-NJ8SX0K49Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Agora è¨­å®š
        const APP_ID = "c553229d8402445a9a5262d2d573161d";
        const CHANNEL_NAME = "museum_tour_01";

        const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
        const tourStatusRef = ref(db, 'tours/' + CHANNEL_NAME + '/isActive');

        const joinBtn = document.getElementById("joinBtn");
        const leaveBtn = document.getElementById("leaveBtn");
        const statusDiv = document.getElementById("status");

        // 1. ç›£è½ç´…ç¶ ç‡ˆ (æ±ºå®šèƒ½å¦åŠ å…¥ / å¼·åˆ¶é€€å‡º)
        onValue(tourStatusRef, async (snapshot) => {
            const isActive = snapshot.val();

            if (isActive === true) {
                // å°è³å“¡é–‹æ©Ÿ
                if (joinBtn.style.display !== "none") {
                    joinBtn.disabled = false;
                    joinBtn.classList.add("active");
                    joinBtn.innerText = "ğŸ”Š å°è³å“¡å·²é–‹å§‹ï¼Œé»æˆ‘åŠ å…¥";
                    statusDiv.innerText = "ç‹€æ…‹ï¼šè¨Šè™Ÿè‰¯å¥½ï¼Œå¯ä»¥åŠ å…¥";
                }
            } else {
                // å°è³å“¡é—œæ©Ÿ (æˆ–çµæŸ) -> å¼·åˆ¶è¸¢äºº
                joinBtn.disabled = true;
                joinBtn.classList.remove("active");
                joinBtn.innerText = "â³ ç­‰å¾…å°è³å“¡é–‹æ©Ÿ...";

                if (client.connectionState === "CONNECTED" || client.connectionState === "CONNECTING") {
                    await client.leave();
                    leaveBtn.style.display = "none";
                    joinBtn.style.display = "inline-block";
                    statusDiv.innerText = "ç‹€æ…‹ï¼šå°è³å“¡å·²çµæŸï¼Œè‡ªå‹•æ–·ç·šã€‚";
                    alert("å°è³å“¡å·²çµæŸå»£æ’­ï¼Œç³»çµ±è‡ªå‹•ç‚ºæ‚¨æ–·ç·šã€‚");
                } else {
                    statusDiv.innerText = "ç‹€æ…‹ï¼šå°è³å“¡ç›®å‰é›¢ç·šä¸­";
                }
            }
        });

        // 2. ç›£è½è²éŸ³ç‹€æ…‹ (åŒ…å«æ˜¯å¦éœéŸ³)
        client.on("user-published", async (user, mediaType) => {
            await client.subscribe(user, mediaType);
            if (mediaType === "audio") {
                user.audioTrack.play();
                statusDiv.innerText = "ç‹€æ…‹ï¼šğŸ”Š æ­£åœ¨æ”¶è½å°è¦½ä¸­...";
            }
        });

        // ç›£è½å°è³å“¡æ˜¯å¦æŒ‰ä¸‹ã€Œæš«åœéº¥å…‹é¢¨ã€
        client.on("user-info-updated", (uid, msg) => {
            if (msg === "mute-audio") {
                 statusDiv.innerText = "ç‹€æ…‹ï¼šğŸ¤ å°è³å“¡æš«æ™‚éœéŸ³ä¸­...";
                 statusDiv.style.color = "#ffa502";
            } else if (msg === "unmute-audio") {
                 statusDiv.innerText = "ç‹€æ…‹ï¼šğŸ”Š æ­£åœ¨æ”¶è½å°è¦½ä¸­...";
                 statusDiv.style.color = "#333";
            }
        });

        // åŠ å…¥æŒ‰éˆ•
        joinBtn.addEventListener("click", async () => {
            try {
                await client.setClientRole("audience");
                await client.join(APP_ID, CHANNEL_NAME, null, null);

                statusDiv.innerText = "ç‹€æ…‹ï¼šğŸ”Š æ­£åœ¨æ”¶è½å°è¦½ä¸­...";
                joinBtn.style.display = "none";
                leaveBtn.style.display = "inline-block";
            } catch (error) {
                console.error(error);
                alert("åŠ å…¥å¤±æ•—ï¼Œè«‹é‡è©¦");
            }
        });

        // é€€å‡ºæŒ‰éˆ• (æ‰‹å‹•)
        leaveBtn.addEventListener("click", async () => {
            await client.leave();
            statusDiv.innerText = "ç‹€æ…‹ï¼šå·²æ‰‹å‹•é€€å‡º";
            leaveBtn.style.display = "none";
            joinBtn.style.display = "inline-block";
        });

    </script>
</body>
</html>
